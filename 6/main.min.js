"use strict";!function(){function showStartButton(){window.innerWidth<window.innerHeight?div.innerHTML="Please rotate your device to watch horizontally ":(div.innerHTML="Start!",div.onclick=function(){playSound(),maxWindow()})}function drawBackground(){context.fillStyle=currentRMS>.6?"#999":"#111",context.fillRect(0,0,canvas.width,canvas.height);for(var a=1;a<9;a++){context.beginPath();var b=window.innerWidth/9;b=a*b,context.fillStyle="hsl("+(250+clusteredFreqData[a]/2)+",100%,20%)",context.arc(b,window.innerHeight/2,window.innerHeight/6+clusteredFreqData[a],0,2*Math.PI),context.fill()}var c=900*currentRMS,d=20*currentRMS;context.beginPath();for(var a=0;a<720;a++){var e=a/360*Math.PI,b=centerx+c*Math.sin(d*e)*Math.cos(e),f=centery+c*Math.sin(d*e)*Math.sin(e);context.lineWidth=10*currentRMS,context.lineTo(b,f)}context.strokeStyle="hsl("+200*currentRMS+",100%,70%)",context.stroke()}function drawCopies(a){for(var b=currentRMS,c=-9;c<9;c+=2)for(var d=100*c,e=360/(c+1),f=0;f<a.polygons.length;f++){context.beginPath();for(var b=currentRMS,g=1;g<a.polygons[f].points.length;g++){var h=a.polygons[f].points[g].x*danceScaneX,i=a.polygons[f].points[g].y*danceScaneY;context.lineTo(h+d,i)}context.fillStyle="hsl("+e+",100%,"+90*b+"%)",context.fill()}}function drawFrame(a,b){currentFrame=b,context.clearRect(0,0,canvas.width,canvas.height),context.globalCompositeOperation=blendModes[25*Math.floor(context.currentTime/240)],drawBackground(),b-lastBomb<100&&drawCopies(a),clusteredFreqData[4]>190&&(drawCopies(a),lastBomb=b);for(var c=0;c<a.polygons.length;c++){context.beginPath();for(var d=5e3,e=0,f=1;f<a.polygons[c].points.length;f++){var g=a.polygons[c].points[f].x*danceScaneX,h=a.polygons[c].points[f].y*danceScaneY;g<d&&(d=g),h>e&&(e=g),context.lineTo(g,h)}centerx=(d+e)/2,context.closePath(),context.fillStyle="#00b0c6",context.fill()}}function loadAudio(a){var b=new XMLHttpRequest;b.open("GET",a,!0),b.responseType="arraybuffer",b.onprogress=function(a){if(a.lengthComputable){var b=a.loaded/a.total;div.innerHTML="Loading music ("+(80+Math.floor(20*b))+"%)"}},b.onerror=function(a){div.innerHTML="Couldn't load music, please reload the page"},b.onload=function(){audioContext.decodeAudioData(b.response,function(a){SoundBuffer=a,showStartButton()},function(){})},b.send()}function maxWindow(){var a=document.fullScreenElement&&null!==document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen,b=document.documentElement;a||(b.requestFullscreen?b.requestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullScreen&&b.webkitRequestFullScreen())}function playSound(){if(!isStarted){isStarted=!0,document.getElementById("click-to-start").style.display="none";try{analyser=audioContext.createAnalyser(),source=audioContext.createBufferSource(),source.buffer=SoundBuffer,source.connect(audioContext.destination),source.connect(analyser),source.start(0),duration=SoundBuffer.duration,analyser.fftSize=1024;var a=analyser.frequencyBinCount;analyser.smoothingTimeConstant=.5,audioDataArray=new Uint8Array(a),availableFreqs=analyser.frequencyBinCount,audioFreqDataArray=new Uint8Array(availableFreqs),source.onended=function(){div.innerHTML="Thank you for watching! Please watch the original video <a href='https://www.youtube.com/watch?v=0ORaAnJYROg' target='blank'>here</a>",div.innerHTML+='<div><div class="fb-share-button" data-href="https://www.omaralshaker.com/Codevember/4/" data-layout="button_count" data-size="small" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.omaralshaker.com%2FCodevember%2F4%2F&amp;src=sdkpreparse">Share</a></div><div>';try{FB.XFBML.parse()}catch(a){}div.style.display="block"},render()}catch(a){console.log(a)}}}function render(){var c,a=0,b=0;for(analyser.getByteTimeDomainData(audioDataArray);b<audioDataArray.length;){var c=audioDataArray[b++]/128-1;a+=c*c}currentRMS=Math.sqrt(a/audioDataArray.length);var d=Math.floor(27.1*audioContext.currentTime);if(d<data.length){drawFrame(window.data[d],d),analyser.getByteFrequencyData(audioFreqDataArray);for(var e=0;e<10;e++){clusteredFreqData[e]=0;for(var f=10*e,g=f+e*(availableFreqs/10),h=0,b=f;b<g;b++)h+=0|audioFreqDataArray[b];h/=g-f,clusteredFreqData[e]=h}requestAnimationFrame(render)}}function loadDanceData(){var req=new XMLHttpRequest;req.addEventListener("progress",function(a){var b=a.loaded/2.1*1024*1024;div.innerHTML="Loading dance data ("+Math.floor(80*b)+"%)"},!1),req.addEventListener("load",function(event){eval(req.responseText),loadAudio("audio.mp3")},!1),req.addEventListener("error",function(a){div.innerHTML="Couldn't load dance data, please reload the page"},!1),req.open("GET","dancing_data.js"),req.send()}var div=document.getElementById("click-to-start"),canvas=document.getElementById("canvas");canvas.width=window.innerWidth,canvas.height=window.innerHeight;var danceScaneX=window.innerWidth/1280,danceScaneY=window.innerHeight/720,duration,centerx=canvas.width/2,centery=canvas.height/2,context=canvas.getContext("2d"),SoundBuffer;window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=new AudioContext,analyser,source,audioDataArray,audioFreqDataArray,currentRMS=0,isStarted=!1,availableFreqs=0,clusteredFreqData=new Array(10),currentFrame,blendModes=["source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","copy","xor","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],lastBomb=-100,currentIndex=0;window.onresize=function(){canvas.width=window.innerWidth,canvas.height=window.innerHeight,centerx=canvas.width/2,centery=canvas.height/2,danceScaneX=window.innerWidth/1280,danceScaneY=window.innerHeight/720;var a=document.getElementById("click-to-start");window.innerWidth<window.innerHeight?a.innerHTML="Please rotate your device to watch horizontally":(a.innerHTML="Start!",a.onclick=function(){playSound(),maxWindow()})},loadDanceData()}();